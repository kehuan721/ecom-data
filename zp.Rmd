---
title: "zp"
author: "Hong Xu"
date: "2015年1月29日"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r KPIs}

##### daily sales


library(ggplot2)
library(ggthemes)
library(scales)
library(gridExtra)
library(dplyr)


zp.sales <- zp %>%
            group_by(day) %>%
            summarise(
              daily_sales = sum(gross_sales, na.rm=T),
              n = n()) %>%
            arrange(day)
              
p.sales_byday <- ggplot(data=zp.sales, aes(x=day, y=daily_sales)) + geom_point(aes(color=daily_sales)) +
                scale_x_date(breaks = date_breaks("months"), labels = date_format("%b")) +
                ggtitle("Daily sales in 2013") + 
                theme(plot.title = element_text(size = 25)) + 
                scale_colour_continuous(name="Daily Sales",
                         breaks=c(400000, 800000, 1200000, 1600000),
                         low = "blue",
                         high = "red",
                         labels=c("0.4M", "0.8M", "1.2M", "1.6M")) +
                ylab("Daily Sales")
  
p.sales_weeks <- ggplot(data=zp.sales, aes(x=day, y=daily_sales)) + geom_point(aes(color=daily_sales)) +
    scale_x_date(breaks = date_breaks("weeks"), limits = c(as.Date("2013-9-28"), as.Date("2013-12-31")))+
  ggtitle("Daily sales from Sept to Dec 2013")  +
                theme(plot.title = element_text(size = 25)) + 
                scale_colour_continuous(name="Daily Sales",
                         breaks=c(400000, 800000, 1200000, 1600000),
                         low = "blue",
                         high = "red",
                         labels=c("0.4M", "0.8M", "1.2M", "1.6M")) +
                ylab("Daily Sales")


sum(zp.sales$daily_sales[months(zp.sales$day) == "October"])/(31/4) 
# weekly sales: 2893930
tail(zp.sales[months(zp.sales$day) == "November",])
##### average order size

zp.order_size <- zp %>%
            group_by(month) %>%
            summarise(
              avg_order_size_by_month = mean(gross_sales, na.rm=T),
              n = n()) %>%
            arrange(month)

p.order_size <- ggplot(aes(x=factor(month), y=avg_order_size_by_month, group=1), data=zp.order_size) +           geom_line(color="grey") + geom_point(size=3, color="red") + ylab("order size") + xlab("month") +
  ggtitle("Order Size by Month, 2013")

p.order_size.cust <- ggplot(aes(x=factor(month), y=gross_sales, group=customer_type), data=zp) + 
  geom_line(stat="summary", fun.y=mean, aes(color=customer_type)) 
p.order_size.mobile <- ggplot(aes(x=factor(month), y=gross_sales, group=factor(is_mobile)), data=zp) + 
  geom_line(stat="summary", fun.y=mean, aes(color=factor(is_mobile))) 

```


```{r Sales and visits, New customer, returning customer}
p.cust_dist <- ggplot(data=zp, aes(x=factor(customer_type), y=..count../sum(..count..))) +  
  geom_bar(fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  ylab("percentage") +
  theme_economist() +
  scale_y_continuous(labels = percent) +
  ggtitle("Customer type distribution")
 

p.cust_visits <- ggplot(data=zp, aes(x=factor(customer_type), y=visits)) + 
  geom_bar(stat="summary", fun.y=sum, fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  theme_economist()  +
  scale_y_continuous(labels = comma) +
  ggtitle("Total number of visits distribution by customer type")

p.cust_visits_rn <- ggplot(data=subset(zp, customer_type != "neither"), aes(x=factor(customer_type), y=visits)) + 
  geom_bar(stat="summary", fun.y=sum, fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  theme_economist() +
  scale_y_continuous(labels = comma) + 
  ggtitle("Total number of visits of new and returning customer")

p.cust_sales_rn <- ggplot(data=subset(zp, customer_type != "neither", !is.na(gross_sales)), aes(x=factor(customer_type), y=gross_sales)) + 
  geom_bar(stat="summary", fun.y=sum, fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  theme_economist() +
  scale_y_continuous(labels = comma) + 
  ggtitle("Total sales of new and returning customer")

ggplot(data=subset(zp, !is.na(gross_sales)), aes(x=factor(customer_type), y=gross_sales)) + 
  geom_bar(stat="summary", fun.y=sum, fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  theme_economist() +
  scale_y_continuous(labels = comma) + 
  ggtitle("Total sales by customer type")

ggplot(data=subset(zp, !is.na(gross_sales)), aes(x=factor(customer_type), y=orders)) + 
  geom_bar(stat="summary", fun.y=sum, fill="grey50", alpha=0.7) +
  scale_x_discrete("Customer Type") +
  theme_economist() +
  scale_y_continuous(labels = comma) + 
  ggtitle("Total orders by customer type ")



## another way to look at visits against cust type
p.cust_visits_dist <- ggplot(data=zp, aes(x = visits)) + 
                    geom_histogram() +
                    #xlim(0, quantile(zp$visits, 0.75)) + 
                    facet_wrap(~customer_type, ncol=1) + 
                    scale_x_log10()


p.cust_visits_dist_dens <- ggplot(data=zp, aes(visits, colour=customer_type)) + 
                    geom_density(adjust=1/2) +
                    theme_economist() +
                    scale_y_continuous(labels = percent) + 
                    scale_x_log10("Number of visits (log10)", breaks=c(10, 100, 1000, 10000)) +
                    ggtitle("Density of visits by customer type")
#by(zp$visits, zp$new_customer, function(x) quantile(x, 0.95))



#### conversion rate
zp.conv <- zp %>%
            group_by(day) %>%
            summarise(
              conv_rate = sum(orders)/sum(visits),
              n_order = sum(if_ordered),
              n = n()) %>%
            arrange(day)
p.conv_rate <- ggplot(aes(x=day, y=conv_rate, group=1), data=zp.conv) + 
  geom_point(size=3, color="red") + geom_smooth()

###############
```     
```{r platform order rate, platform trend}
zp.order_pltfm <- zp %>%
            group_by(platform) %>%
            summarise(
              order_rate_by_pltfm = sum(if_ordered),
              is_mobile = mean(is_mobile),
              n = n()) %>%
            arrange(platform)
p.order_pltfm <- ggplot(aes(x=platform, y=order_rate_by_pltfm/n), data=zp.order_pltfm) + 
  geom_bar(stat="identity", aes(fill=factor(is_mobile))) +
  scale_y_continuous(labels = percent)


zp.trend_pltfm <- zp %>%
            group_by(month) %>%
            summarise(
              mobile_rate = sum(is_mobile),
              n = n()) %>%
            arrange(month)
p.trend_pltfm <- ggplot(aes(x=factor(month), y=mobile_rate/n, group=1), data=zp.trend_pltfm) + 
  geom_line() + geom_point(size=3, color="red") +
  scale_y_continuous("mobile rate", labels = percent, limits=c(0,1)) 
```

```{r product page views}

p.page_v <- ggplot(data=zp, aes(product_page_views)) + 
  geom_histogram(binwidth=0.1) + 
  scale_x_log10() + 
  facet_wrap(~customer_type, ncol=1)


p.page_s <- ggplot(data=zp, aes(search_page_views)) + 
  geom_histogram(binwidth=0.1) + 
  scale_x_log10() + 
  facet_wrap(~customer_type, ncol=1)


p.page_v_platform <- ggplot(data=zp, aes(product_page_views)) + 
  geom_histogram(binwidth=0.1) + 
  scale_x_log10() + 
  facet_wrap(~is_mobile, ncol=1)

p.page_s_platform <- ggplot(data=zp, aes(search_page_views)) + 
  geom_histogram(binwidth=0.1) + 
  scale_x_log10() + 
  facet_wrap(~is_mobile, ncol=1)



p.page_v_platform_poly <- ggplot(data=zp, aes(x=product_page_views, y=..count../sum(..count..))) +
  geom_freqpoly(aes(color=factor(is_mobile)), binwidth=1) +
  scale_x_continuous(limits=c(0,200), breaks=seq(0, 200, 10)) +
  scale_y_continuous(labels=percent) + 
  xlab('Product page views') +
  ylab('Percentage of visitors with that product page views count') +
  scale_colour_discrete(name="Platform Type",
                         breaks=c(0, 1),
                         labels=c("Desktop", "Mobile"))



p.page_s_platform_poly <- ggplot(data=zp, aes(x=search_page_views, y=..count../sum(..count..))) +
  geom_freqpoly(aes(color=factor(is_mobile)), binwidth=1) +
  scale_x_continuous(limits=c(0,300), breaks=seq(0, 300, 10)) +
  scale_y_continuous(labels=percent) + 
  xlab('Search page views') +
  ylab('Percentage of visitors with that search page views count') +
  scale_colour_discrete(name="Platform Type",
                         breaks=c(0, 1),
                         labels=c("Desktop", "Mobile"))

with(zp, cor.test(search_page_views, product_page_views))
# cor: 0.9756209 


```

```{r shopping cart}
zp$is_ordered
ggplot(data=subset(zp, add_to_cart>0), aes(x=factor(if_ordered), y=..count../sum(..count..))) + geom_bar()

zp.cart_order <- zp %>%
                filter(add_to_cart > 0) %>%
                group_by(day) %>%
                summarise(
                  add_to_cart_freq = n(),
                  order_freq = sum(if_ordered)) %>%
                arrange(day)

library(reshape2)
zp.cart_order.long <- melt(zp.cart_order, id="day")

p.cart_abandon <- ggplot(data=zp.cart_order.long, aes(x=day, y=value, group=variable)) +
  geom_line(aes(color=variable)) 



zp.cart_order.wide <- zp %>%
                filter(add_to_cart > 0) %>%
                group_by(day, is_mobile, customer_type) %>%
                summarise(
                  add_to_cart_freq = n(),
                  order_freq = sum(if_ordered)) %>%
                arrange(day)


zp.cart_order.long2 <- melt(zp.cart_order.wide, id = c("day", "is_mobile", "customer_type"))
zp.cart_order.long2 <- zp.cart_order.long2[order(zp.cart_order.long2$day),]

p.cart_abandon_mobile <- ggplot(data=zp.cart_order.long2, aes(x=day, y=value, group=variable, colour=variable)) +
  geom_line(stat="summary", fun.y=sum) + 
  facet_grid(is_mobile ~ .)


p.cart_abandon_customer <- ggplot(data=zp.cart_order.long2, aes(x=day, y=value, group=variable, colour=variable)) +
  geom_line(stat="summary", fun.y=sum) + 
  facet_grid(customer_type ~ .)


zp.cart_order.wide.mobile <- zp %>%
                filter(add_to_cart > 0) %>%
                group_by(day, is_mobile) %>%
                summarise(
                  add_to_cart_freq = n(),
                  order_freq = sum(if_ordered)) %>%
                arrange(day)

zp.cart_order.wide.mobile$abandon_rate <- 1 - zp.cart_order.wide.mobile$order_freq/zp.cart_order.wide.mobile$add_to_cart_freq
p.abandon_rate.m <- ggplot(data=zp.cart_order.wide.mobile, aes(x=day, y=abandon_rate, group=is_mobile, colour=factor(is_mobile))) + geom_line() + geom_smooth(method=loess)



zp.cart_order.wide.customer <- zp %>%
                filter(add_to_cart > 0) %>%
                group_by(day, customer_type) %>%
                summarise(
                  add_to_cart_freq = n(),
                  order_freq = sum(if_ordered)) %>%
                arrange(day)

zp.cart_order.wide.customer$abandon_rate <- 1 - zp.cart_order.wide.customer$order_freq/zp.cart_order.wide.customer$add_to_cart_freq
p.abandon_rate.c <- ggplot(data=zp.cart_order.wide.customer, aes(x=day, y=abandon_rate, group=customer_type, colour=factor(customer_type))) + geom_line() + geom_smooth(method=loess)
  
```

```{r linear regression}
library(MASS)
library(sjPlot)

table(zp$platform)
fit <- with(data=subset(subset(zp, customer_type != "neither"), platform != ""), lm(orders ~ visits + site + customer_type + platform))
sjp.setTheme(axis.title.size = 1, axis.textsize = 1, legend.size = .85, geom.label.size = 3.5)
sjp.lm(fit,
       axisTitle.x="different platform, site, and customer type's impact on number of orders",
       breakLabelsAt = 20
       )

fit.t <- with(data=subset(zp, platform != ""), lm(orders ~ site + customer_type + platform))
sjp.setTheme(axis.title.size = 1, axis.textsize = 1, legend.size = .85, geom.label.size = 3.5)
sjp.lm(fit.t,
       axisTitle.x="different platform, site, and customer type's impact on number of orders",
       breakLabelsAt = 20
       )

#sjp.lm(fit, type = "pred")

```
```{r decision tree}
library(rpart)
library(rpart.plot)
library(rattle)
order.rpart <- rpart(formula = if_ordered ~ site + platform + search_page_views + customer_type, data=subset(subset(zp, customer_type != "neither"), platform != ""), method="class", parms=list(split="information"), control=list(minsplit=150, minbucket=50), cp=0.01)
plot(order.rpart)
text(order.rpart, cex=0.75)
printcp(order.rpart)

# Absolute cross-validated error rate: 0.29584 * 0.19259 = 0.057


cols <- ifelse(order.rpart$frame$yval == 1, "darkred", "green4")
# green if ordered

prp(order.rpart, main="Decion Tree: Predicting If A Customer Will Make Order(s)",
      extra=103, #  misclassification rate at the node, expressed as the number of incorrect classifications and the number of observations in the node; also display the percentage of observations in the node. 
      #nn=TRUE, # display the node numbers
      under = TRUE,
      fallen.leaves=TRUE, # put the leaves on the bottom of the page
      branch=1, # change angle of branch lines
      faclen=0, # do not abbreviate factor levels
      trace=1, # print the automatically calculated cex
      shadow.col="gray", # shadows under the leaves
      cex = 0.6, # node size
      #branch.lty=3, # draw branches using dotted lines
      split.cex=1.1, # make the split text larger than the node text
      split.prefix="is ", # put "is " before split text
      split.suffix="?", # put "?" after split text
      box.col=cols, border.col=cols, # green if survived
      split.box.col="lightgray", # lightgray split boxes (default is white)
      split.border.col="darkgray", # darkgray border on split boxes
      split.round=.5) # round the split box corners a tad



order.rpart.t1 <- rpart(formula = if_ordered ~ site + platform + search_page_views, data=subset(subset(zp, customer_type != "neither"), platform != ""), method="class", parms=list(split="information"), control=list(minsplit=150, minbucket=50), cp=0.01)
plot(order.rpart.t1)
text(order.rpart.t1, cex=0.75)
printcp(order.rpart.t1)

#### 
order.rpart.t2 <- rpart(formula = if_ordered ~ site + platform, data=subset(zp, platform != ""), method="class", parms=list(split="information"), control=list(minsplit=150, minbucket=50), cp=0.001)
plot(order.rpart.t2)
text(order.rpart.t2, cex=0.75)
printcp(order.rpart.t2)

# Absolute cross-validated error rate: 0.57669 * 0.4363 = 0.2516098



cols <- ifelse(order.rpart.t2$frame$yval == 1, "indianred3", "green4")
# green if ordered

prp(order.rpart.t2, main="Decion Tree: Predicting If A Customer Will Make Order(s)",
      extra=103, #  misclassification rate at the node, expressed as the number of incorrect classifications and the number of observations in the node; also display the percentage of observations in the node. 
      #nn=TRUE, # display the node numbers
      under = TRUE,
      type = 3,
      fallen.leaves=TRUE, # put the leaves on the bottom of the page
      branch=1, # change angle of branch lines
      faclen=0, # do not abbreviate factor levels
      trace=1, # print the automatically calculated cex
      #shadow.col="gray", # shadows under the leaves
      cex = 0.6, # node size
      branch.col="gray20", 
      branch.lty = 3,
      branch.lwd = 3,
      split.cex=1.1, # make the split text larger than the node text
      split.prefix="is ", # put "is " before split text
      split.suffix="?", # put "?" after split text
      box.col=cols, border.col=cols, # green if survived
      split.col = "gray20",
      #split.box.col="lightgray", # lightgray split boxes (default is white)
      #split.border.col="darkgray", # darkgray border on split boxes
      #split.round=.5 # round the split box corners a tad
     ) 



```










